<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Optimal Binning for Categorical Variables using Divergence Measures (V2) — optimal_binning_categorical_dmiv • OptimalBinningWoE</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Optimal Binning for Categorical Variables using Divergence Measures (V2) — optimal_binning_categorical_dmiv"><meta name="description" content="Performs optimal binning for categorical variables using various divergence measures as proposed
by Zeng (2013). This is Version 2, incorporating fixes for potential crashes and performance improvements.
This method transforms categorical features into discrete bins by maximizing
the statistical divergence between distributions of positive and negative cases, while
maintaining interpretability constraints."><meta property="og:description" content="Performs optimal binning for categorical variables using various divergence measures as proposed
by Zeng (2013). This is Version 2, incorporating fixes for potential crashes and performance improvements.
This method transforms categorical features into discrete bins by maximizing
the statistical divergence between distributions of positive and negative cases, while
maintaining interpretability constraints."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">OptimalBinningWoE</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.3.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Optimal Binning for Categorical Variables using Divergence Measures (V2)</h1>

      <div class="d-none name"><code>optimal_binning_categorical_dmiv.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Performs optimal binning for categorical variables using various divergence measures as proposed
by Zeng (2013). This is Version 2, incorporating fixes for potential crashes and performance improvements.
This method transforms categorical features into discrete bins by maximizing
the statistical divergence between distributions of positive and negative cases, while
maintaining interpretability constraints.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">optimal_binning_categorical_dmiv</span><span class="op">(</span></span>
<span>  <span class="va">target</span>,</span>
<span>  <span class="va">feature</span>,</span>
<span>  min_bins <span class="op">=</span> <span class="fl">3L</span>,</span>
<span>  max_bins <span class="op">=</span> <span class="fl">5L</span>,</span>
<span>  bin_cutoff <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  max_n_prebins <span class="op">=</span> <span class="fl">20L</span>,</span>
<span>  bin_separator <span class="op">=</span> <span class="st">"%;%"</span>,</span>
<span>  convergence_threshold <span class="op">=</span> <span class="fl">1e-06</span>,</span>
<span>  max_iterations <span class="op">=</span> <span class="fl">1000L</span>,</span>
<span>  bin_method <span class="op">=</span> <span class="st">"woe1"</span>,</span>
<span>  divergence_method <span class="op">=</span> <span class="st">"l2"</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-target">target<a class="anchor" aria-label="anchor" href="#arg-target"></a></dt>
<dd><p>An integer binary vector (0 or 1) representing the target variable. Cannot contain NAs.</p></dd>


<dt id="arg-feature">feature<a class="anchor" aria-label="anchor" href="#arg-feature"></a></dt>
<dd><p>A character vector of categorical feature values. <code>NA</code> values will be treated as a distinct category "NA".</p></dd>


<dt id="arg-min-bins">min_bins<a class="anchor" aria-label="anchor" href="#arg-min-bins"></a></dt>
<dd><p>Minimum number of bins to generate (default: 3, must be &gt;= 2).</p></dd>


<dt id="arg-max-bins">max_bins<a class="anchor" aria-label="anchor" href="#arg-max-bins"></a></dt>
<dd><p>Maximum number of bins to generate (default: 5).</p></dd>


<dt id="arg-bin-cutoff">bin_cutoff<a class="anchor" aria-label="anchor" href="#arg-bin-cutoff"></a></dt>
<dd><p>Minimum frequency fraction threshold used for OLD rare category handling (NOTE: V2 primarily uses <code>max_n_prebins</code> and <code>min_prebin_count</code> for initial handling, this cutoff is less relevant now but kept for interface compatibility). Default: 0.05.</p></dd>


<dt id="arg-max-n-prebins">max_n_prebins<a class="anchor" aria-label="anchor" href="#arg-max-n-prebins"></a></dt>
<dd><p>Maximum number of initial bins before merging starts. If unique categories exceed this, categories with counts &lt; <code>min_prebin_count</code> (hardcoded as 5 currently) are grouped into a "PREBIN_OTHER" bin (default: 20).</p></dd>


<dt id="arg-bin-separator">bin_separator<a class="anchor" aria-label="anchor" href="#arg-bin-separator"></a></dt>
<dd><p>String separator for concatenating category names in bins (default: "%;%").</p></dd>


<dt id="arg-convergence-threshold">convergence_threshold<a class="anchor" aria-label="anchor" href="#arg-convergence-threshold"></a></dt>
<dd><p>Convergence threshold for the change in minimum divergence between iterations during merging (default: 1e-6).</p></dd>


<dt id="arg-max-iterations">max_iterations<a class="anchor" aria-label="anchor" href="#arg-max-iterations"></a></dt>
<dd><p>Maximum number of merging iterations allowed (default: 1000).</p></dd>


<dt id="arg-bin-method">bin_method<a class="anchor" aria-label="anchor" href="#arg-bin-method"></a></dt>
<dd><p>Method for WoE calculation, either 'woe' (traditional) or 'woe1' (Zeng's, smoothed) (default: 'woe1').</p></dd>


<dt id="arg-divergence-method">divergence_method<a class="anchor" aria-label="anchor" href="#arg-divergence-method"></a></dt>
<dd><p>Divergence measure to optimize for merging (lower is better). Options:</p><ul><li><p>'he': Hellinger Distance</p></li>
<li><p>'kl': Symmetrized Kullback-Leibler Divergence</p></li>
<li><p>'tr': Triangular Discrimination</p></li>
<li><p>'klj': J-Divergence (Symmetric KL)</p></li>
<li><p>'sc': Symmetric Chi-Square Divergence</p></li>
<li><p>'js': Jensen-Shannon Divergence</p></li>
<li><p>'l1': L1 metric (Manhattan distance) on local bin proportions p/(p+n) vs q/(p+n)</p></li>
<li><p>'l2': L2 metric (Euclidean distance) on local bin proportions - Default</p></li>
<li><p>'ln': L-infinity metric (Maximum distance) on local bin proportions</p></li>
</ul></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>A list containing:</p>
<dl><dt>id</dt>
<dd><p>Numeric identifiers for each bin (1-based).</p></dd>

<dt>bin</dt>
<dd><p>Character vector with the categories in each bin (or "PREBIN_OTHER").</p></dd>

<dt>woe</dt>
<dd><p>Numeric vector with the Weight of Evidence values for each bin.</p></dd>

<dt>divergence</dt>
<dd><p>Numeric vector with the divergence measure contribution for each bin (for L2/L-inf, this holds an intermediate value: <code>(p-n)^2</code> or <code>|p-n|</code> respectively, where p/n are proportions relative to total pos/neg).</p></dd>

<dt>count</dt>
<dd><p>Integer vector with the total number of observations in each bin.</p></dd>

<dt>count_pos</dt>
<dd><p>Integer vector with the number of positive observations in each bin.</p></dd>

<dt>count_neg</dt>
<dd><p>Integer vector with the number of negative observations in each bin.</p></dd>

<dt>converged</dt>
<dd><p>Logical value indicating whether the merging algorithm converged before hitting max iterations or <code>max_bins</code>.</p></dd>

<dt>iterations</dt>
<dd><p>Number of merging iterations executed.</p></dd>

<dt>total_divergence</dt>
<dd><p>The total divergence measure of the final binning solution (calculated correctly for all methods, including L2/L-inf).</p></dd>

<dt>bin_method</dt>
<dd><p>The WoE calculation method used ('woe' or 'woe1').</p></dd>

<dt>divergence_method</dt>
<dd><p>The divergence measure used for optimization.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This implementation (V2) addresses potential stability and performance issues found in V1.
It follows the framework from Zeng (2013) using various divergence measures.
The <code>max_n_prebins</code> parameter is now functional, grouping rare categories initially if cardinality is high.
The similarity matrix update logic during merging and splitting has been corrected and optimized.
Calculation and reporting of L2/L-infinity total divergence are corrected.
Formulas for divergence measures (where P = (p_1,..p_n), Q = (q_1,..q_n) are distributions):
$$Hellinger: h(P||Q) = \frac{1}{2}\sum_{i=1}^{n}(\sqrt{p_i} - \sqrt{q_i})^2$$
$$Symmetric KL: D_S(P||Q) = D(P||Q) + D(Q||P)$$
$$J-Divergence: J(P||Q) = D_S(P||Q)$$
$$Triangular: \Delta(P||Q) = \sum_{i=1}^{n}\frac{(p_i - q_i)^2}{p_i + q_i}$$
$$Chi-Square Symm: \psi(P||Q) = \sum_{i=1}^{n}\frac{(p_i - q_i)^2(p_i + q_i)}{p_iq_i}$$
$$Jensen-Shannon: JSD(P||Q) = \frac{1}{2}D(P||M) + \frac{1}{2}D(Q||M), M=\frac{P+Q}{2}$$
$$L1 (local proportions): L_1(p_1, p_2) = | \frac{g_1}{g_1+b_1} - \frac{g_2}{g_2+b_2} | + | \frac{b_1}{g_1+b_1} - \frac{b_2}{g_2+b_2} |$$ (Note: The code calculates L1 based on global proportions p_i/P vs n_i/N for merging criteria, but documentation needs clarification if local prop is intended) -&gt; V2 Code calculates L1/L2/Ln based on <em>local</em> proportions for the bin similarity/distance now.
$$L2 (local proportions): L_2(p_1, p_2) = \sqrt{ (\frac{g_1}{g_1+b_1} - \frac{g_2}{g_2+b_2})^2 + (\frac{b_1}{g_1+b_1} - \frac{b_2}{g_2+b_2})^2 }$$
$$L-infinity (local proportions): L_\infty(p_1, p_2) = \max ( | \frac{g_1}{g_1+b_1} - \frac{g_2}{g_2+b_2} |, | \frac{b_1}{g_1+b_1} - \frac{b_2}{g_2+b_2} | ) $$
WoE Methods:
$$Traditional WoE: \ln(\frac{g_i/G}{b_i/B})$$
$$Zeng's WOE1: \ln(\frac{g_i + 0.5}{b_i + 0.5})$$ (using smoothing)</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Zeng, G. (2013). Metric Divergence Measures and Information Value in Credit Scoring.
Journal of Mathematics, 2013, Article ID 848271, 10 pages.</p>
<p>Siddiqi, N. (2006). Credit Risk Scorecards: Developing and Implementing Intelligent Credit Scoring.
John Wiley &amp; Sons.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="co"># Generate sample data</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span></span>
<span class="r-in"><span><span class="va">categories</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span>, <span class="st">"C"</span>, <span class="st">"D"</span>, <span class="st">"E"</span>, <span class="st">"F"</span>, <span class="st">"G"</span>, <span class="st">"H"</span>, <span class="st">"I"</span>, <span class="st">"J"</span>, <span class="st">"RARE1"</span>, <span class="st">"RARE2"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">feature</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">categories</span>, <span class="va">n</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.09</span>, <span class="fl">10</span><span class="op">)</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">feature</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n</span>, <span class="fl">50</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span> <span class="co"># Add some NAs</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create target with different distribution per category</span></span></span>
<span class="r-in"><span><span class="va">base_probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>, <span class="fl">0.6</span>, <span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="fl">0.95</span>, <span class="fl">0.05</span>, <span class="fl">0.99</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">feature</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span></span>
<span class="r-in"><span>    <span class="va">target</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="co"># Assign random target for NA category</span></span></span>
<span class="r-in"><span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span></span>
<span class="r-in"><span>     <span class="va">cat_idx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">feature</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">categories</span><span class="op">)</span></span></span>
<span class="r-in"><span>     <span class="va">target</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="va">base_probs</span><span class="op">[</span><span class="va">cat_idx</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">}</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Apply optimal binning V2 with L2 metric and WOE1</span></span></span>
<span class="r-in"><span><span class="va">result_v2</span> <span class="op">&lt;-</span> <span class="fu">optimal_binning_categorical_dmiv_v2</span><span class="op">(</span><span class="va">target</span>, <span class="va">feature</span>, max_bins <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_v2</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Test with high cardinality and max_n_prebins</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">n_high</span> <span class="op">&lt;-</span> <span class="fl">5000</span></span></span>
<span class="r-in"><span><span class="va">categories_high</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"CAT_"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">feature_high</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="va">categories_high</span>, <span class="va">n_high</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">target_high</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n_high</span>, <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_high</span>, <span class="fl">0.1</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span> <span class="co"># Random target</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">result_prebin</span> <span class="op">&lt;-</span> <span class="fu">optimal_binning_categorical_dmiv_v2</span><span class="op">(</span></span></span>
<span class="r-in"><span>   <span class="va">target_high</span>,</span></span>
<span class="r-in"><span>   <span class="va">feature_high</span>,</span></span>
<span class="r-in"><span>   max_n_prebins <span class="op">=</span> <span class="fl">15</span>, <span class="co"># Force pre-binning</span></span></span>
<span class="r-in"><span>   max_bins <span class="op">=</span> <span class="fl">5</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_prebin</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">result_prebin</span><span class="op">$</span><span class="va">bin</span><span class="op">)</span> <span class="co"># Check for PREBIN_OTHER</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Lopes J. E.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

